{% load customtags %}
<div id="assignments" class="tab-pane fade">
  <div class="container">

    <div class="row">
      <div class="col-lg-12 text-center">
        <h2>Assignments</h2>
        <hr>
      </div>
    </div>

    {% if user.privilege == 1 %}
    <div class="row">
      <p class="text-right"><a class="btn btn-add" data-toggle="collapse" data-target="#form-assignment"><i class="fa fa-plus"></i></a></p>
      <div class="col-lg-offset-2 col-lg-8 collapse-group">
        <form class="form collapse form-assignment" method="post" name="newassignment" id="form-assignment">
          {% csrf_token %}
          <div class="row control-group">
            <h3> Post New Assignment </h3>
          </div>
          <div class="row control-group">
            <div class="col-md-4 form-group floating-label-form-group controls">
              <label>Date</label>
              <input type="text" name="date" class="form-control input-date" placeholder="Date" id="date-assignment" required>
            </div>
            <div class="form-group col-md-2 col-md-offset-1">
                <div class="checkbox chekbox-pinned">
                    <label><input id="pinned-assignment" name="pinned" type="checkbox"> Pinned</label>
                </div>
            </div>
            <div class="form-group col-md-offset-1 col-md-4 select-group">
              <label class="lab">Group: </label>
              <select name="group" id="groups">
                {% for value in grouplist %}
                <option value="{{value}}">{{value}}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="row control-group">
            <div class="form-group col-md-8 select-group">
              <label class="lab">Subject: </label>
              <select name="subject" id="subjects">
                {% for subject in subjectlist %}
                <option value="{{subject.code}}">{{subject.name}}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="row control-group">
            <div class="form-group col-xs-12 floating-label-form-group controls">
              <label>Summary</label>
              <input type="text" name="summary" class="form-control" placeholder="Summary" id="summary" required>
            </div>
          </div>
          <div class="row control-group">
            <div class="form-group col-xs-12 floating-label-form-group controls">
              <label>Details</label>
              <textarea rows="3" name="details" class="form-control" placeholder="Details" id="detail" required></textarea>
              <p class="help-block text-danger"></p>
            </div>
          </div>
          <div class="row">
                  <div class="form-group col-xs-12 ">
            <button name="post_assignment" type="submit" class="btn btn-success btn-lg">Post</button>
        </div>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

    <div class="row">
      <div class="col-lg-offset-2 col-lg-8">
        <div class="list-group list-group-assignment">
          {% for assignment in assignments %}
          <div class="list-group-item list-group-item-assignment {% if assignment.pk in unseen_assignments %}list-group-item-unseen{% endif %}" {% if assignment.pk in unseen_assignments %} id="list-group-item-unseen-assignment-{{assignment.pk}}"{% endif %}>
            <div class="topcorner">
              {% if assignment.date %}
              <span class="assignment-date"> {{assignment.date|daysuntil}}</span> {%else%}
              <a class="btn btn-sm">
                <i class="fa fa-thumb-tack pin-icon"></i>
              </a>
              {% endif %}
              {% if user.privilege == 1 %}
              <a class="btn btn-delete" href="javascript:DeleteAssignment({{assignment.pk}})" onclick="return confirm('Are you sure?');"><i class="fa fa-trash-o"></i></a>
              <a class="btn btn-share-on-fb" onclick="fb_share_open('Assignment', '{{assignment.summary}}', '{{assignment.poster|name_of_user}}', '{{assignment.details}}', '{{assignment.date}}', '{{assignment.subject}}', '{{assignment.groups}}');" data-toggle="modal" data-target="#fb_share_modal"><i class="fa fa-facebook-square"></i></a>
              {% endif %}
              <a class="btn btn-sm" data-toggle="collapse" data-target="#detail{{forloop.counter}}" href="javascript:SetAssignmentSeen({{assignment.pk}})">
                <i class="fa fa-expand"></i>
              </a>
            </div>

            <h4 class="list-group-item-heading">{{assignment.subject}}</h4>

            <p class="list-group-item-text">
              <small>{{assignment.summary}}</small>

            </p>

            <p class="list-group-item-text">
              <small>posted by: {{assignment.poster|name_of_user}}</small>
            </p>

            <div class="collapse-group">
              {% autoescape off %}
              <p class="collapse list-group-item-text" id="detail{{forloop.counter}}">
                {{assignment.details|urlize}}
              </p>
              {% endautoescape %}
            </div>
          </div>
          {%empty%}
          <div class="list-group-item list-group-item-empty">
              <p>No recent assignment found</p>
          </div>
          {%endfor%}
        </div>
      </div>
    </div>

  </div>
</div>

<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script>
    function DeleteAssignment(pk) {
        $.post("{% url 'classroom:delete' %}", { type:"assignment", pk: pk, "csrfmiddlewaretoken": getCookie('csrftoken') })
            .done(function(data) {
                location.reload();
            });
    }
    function SetAssignmentSeen(pk) {
        $.post("{% url 'classroom:set_post_seen' %}", { type:"assignment", pk: pk, "csrfmiddlewaretoken": getCookie('csrftoken') })
            .done(function(data) {
                var li = document.getElementById("list-group-item-unseen-assignment-"+pk);
                if(li){
                    li.className = li.className.replace('list-group-item-unseen', '');
                }
                var nb = document.getElementById("badge-menu-unseen-assignments");
                var un = Number(nb.innerHTML);
                if(un > 0){
                    --un;
                    nb.innerHTML = un;
                }
                if(un == 0){
                    nb.style.display='none';
                    var nnb = document.getElementById("badge-menu-unseen-notices");
                    var unn = 0;
                    if(nnb){
                        unn = Number(nnb.innerHTML);
                    }
                if(unn == 0) document.getElementById('toggle-badge-unseen').style.display='none';
                }
            })
    }
</script>
